name: Domain Link GÃ¼ncelleyici

on:
  schedule:
    - cron: "0 */1 * * *"  # Her saatte bir
  workflow_dispatch:       # Manuel tetikleme

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Push iÃ§in tam geÃ§miÅŸ

      # --------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # --------------------------
      - name: Install dependencies
        run: pip install requests

      # --------------------------
      - name: Domain linklerini kontrol et ve gÃ¼ncelle
        id: updater
        run: |
          import os, requests

          changed_files = []

          def resolve_final_url(url):
              try:
                  r = requests.get(url, allow_redirects=True, timeout=10, stream=True)
                  final = r.url
                  r.close()
                  return final
              except requests.RequestException:
                  return None

          for fname in os.listdir("."):
              if not fname.endswith(".txt") or fname == "hesapkontrol.txt":
                  continue

              path = os.path.join(".", fname)
              with open(path, "r", encoding="utf-8") as f:
                  url = f.read().strip()

              if not url:
                  continue

              final = resolve_final_url(url)
              domain_name = os.path.splitext(fname)[0].capitalize()

              if final is None:
                  print(f"{domain_name}\nâŒ Domain kapanmÄ±ÅŸ olabilir, eriÅŸim yok.\nURL: {url}\n")
                  continue

              normalized_final = final.rstrip("/")
              normalized_url = url.rstrip("/")

              if normalized_final != normalized_url:
                  with open(path, "w", encoding="utf-8") as f:
                      f.write(normalized_final + "\n")
                  print(f"{domain_name}\nðŸ”€ Domain yÃ¶nlendirmesi bulundu.\nURL: {url} â†’ {normalized_final} (txt dosyasÄ± gÃ¼ncellendi)\n")
                  changed_files.append(fname)
              else:
                  print(f"{domain_name}\nâœ… Domain hala geÃ§erlidir.\nURL: {url}\n")

          # Environment file ile output ayarla (set-output yerine)
          changed_files_str = ",".join(changed_files)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f"changed_files={changed_files_str}\n")
        shell: python

      # --------------------------
      - name: Commit ve push deÄŸiÅŸen dosyalar
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --cached --quiet; then
            echo "DeÄŸiÅŸiklik yok."
          else
            git commit -m "Domain linkleri gÃ¼ncellendi"
            git push

      # --------------------------
      - name: Trigger mapped workflows
        shell: bash
        run: |
          declare -A file_map
          # Dosya -> workflow API URL eÅŸlemesi
          file_map[dizigom.txt]="https://api.github.com/repos/zerodayip/dizigom/dispatches"
          # Ä°stersen baÅŸka dosya -> workflow ekleyebilirsin
          # file_map[digerdosya.txt]="https://api.github.com/repos/xyz/other/dispatches"

          # Python step output'undan deÄŸiÅŸen dosyalarÄ± al
          for f in $(echo "${{ steps.updater.outputs.changed_files }}" | tr ',' ' '); do
            url=${file_map[$f]}
            if [ -n "$url" ]; then
              echo "Tetikleniyor: $f -> $url"
              curl -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                -d '{"event_type":"domain-update","client_payload":{"branch":"main"}}' \
                "$url"
            fi
          done
